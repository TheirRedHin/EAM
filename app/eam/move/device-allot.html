<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>设备变卖</title>
    <link rel="stylesheet" href="../../../mui/css/mui.min.css"/>
    <link rel="stylesheet" href="../../../jxm/css/jxm.css">
   	<style type="text/css">
    	.mui-bar {
			-webkit-box-shadow: none;
			box-shadow: none;
		}
		h5 {
	    	font-size: 14px;
	    	padding: 8px 5px 6px;
	    	background-color: #efeff4;
	    }
	    .head-search {
			padding-top: 1px;
			height: 50px !important; 
		}
		.head-search button {
			height: 48px; 
			width: 18%;
			border: none;
			border-radius: 0 !important;
			background-color:#f7f7f7;
		}
		.head-search input {
			width:62%; 
			height: 50px; 
			border: none;
		}
    	.label-red {
			padding-left: 5px;
			color:red !important;
		}
		.text-disabled {
			background-color: #EEEEEE;
		}
		.iconfont{
			font-size:24px;
		}
		.listtip {
			padding-top: 20px;
			text-align: center;
			background-color: white;
			height: 140px;
			color: #CCCCCC;
		}
		.footer{
			position:static;
			padding-top: 8px;
			padding-left: 20px;
			padding-right: 20px;
		}
		#save{
			float: left;
		}
		.btncommit{
			width: 50%;
			
		}
		#btncommit{
			float: right;
		}
		
		.listtip{
			padding-top: 20px;
			text-align: center;
			background-color: white;
			height: 100px;
			color: #CCCCCC;
		}
	</style>
</head>
<body>
	<header class="mui-bar mui-bar-nav mui-bar-primary"  id="head">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">设备变卖</h1>
	</header>
	<nav class="mui-bar mui-bar-footer">
		<center>
			<button id="save" type="button" class="mui-btn mui-btn-block mui-btn-primary btncommit" style="width: 45%;font-size: 17px;">保存</button>
			<button id="btncommit" type="button" class="mui-btn mui-btn-block mui-btn-primary btncommit" style="width: 45%;font-size: 17px;">提交</button>
		</center>
	</nav>
	<!--工单基本信息-->
	<div class="mui-content">
		<!--<h5>基本信息</h5>-->
		<form class="mui-input-group">
			<div class="mui-input-row" >
				<label>变卖单号</label>
				<!--<input id='out_dept' type="text" readonly="readonly" placeholder="不可编辑"/>-->
				<input id='vary_code' type="text" readonly="readonly" style="background-color: #F2F2F2;"/>
			</div>
			<div class="mui-input-row" >
				<label>登记人</label>
				<input id='eidt_user' type="text" readonly="readonly" style="background-color: #F2F2F2;"/>
				<input id="eidt_userid" type="hidden"/>
			</div>
			<div class="mui-input-row" >
				<label>申请日期</label>
				<input id='apply_date'  type="date" style="background-color: #F2F2F2;"/>
			</div>
			<div class="mui-input-row" >
				<label>使用部门<span class="label-red">*</span></label>
				<input id='dept_name' type="text" readonly="readonly" placeholder="请选择使用部门"/>
				<input id="dept_id" type="hidden"/>
			</div>
			<div class="mui-input-row mui-hidden" >
				<label>二级单位</label>
				<input id='sec_dept'  type="text" readonly="readonly" />
				<input id="sec_deptid" type="hidden"/>
			</div>
			<div class="mui-input-row" >
				<label>接收单位<span class="label-red">*</span></label>
				<input id='receiving'  type="text" class="mui-input-clear" placeholder="请输入接收单位"/>
			</div>
			<div class="mui-input-row mui-hidden" >
				<label>变卖日期</label>
				<input id='vary_date' type="text" readonly="readonly" placeholder="不可编辑" />
			</div>
			<div class="mui-input-row" style="height: 55px;">
				<label>变卖总金额(元)</label>
				<input id='sum_allot_money' type="number" readonly="readonly" style="background-color: #F2F2F2;height: 55px;"/>
			</div>
			<div class="mui-input-row mui-hidden" style="height: 55px;">
				<label>设备总原值(元)</label>
				<input id='sum_org_value' type="number" readonly="readonly" style="background-color: #F2F2F2;height: 55px;"/>
			</div>
			<div class="mui-input-row mui-hidden" style="height: 55px;">
				<label>设备总净值(元)</label>
				<input id='sum_net_value' type="number" readonly="readonly" style="background-color: #F2F2F2;height: 55px;"/>
			</div>
			<div class="mui-input-row mui-hidden" style="height: 55px;">
				<label>总已提折旧(元)</label>
				<input id='sum_dep_value' type="number" readonly="readonly" style="background-color: #F2F2F2;height: 55px;"/>
			</div>
			
			<div class="mui-input-row" style="height: 100px;">
				<label>变卖原因<span class="label-red">*</span></label>
				<textarea id="reasons" rows="4"  placeholder="请输入变卖原因"></textarea>
			</div>
			<div class="mui-input-row" style="height: 100px;">
				<label>设备技术状态</label>
				<textarea id="tech_status" rows="4"  ></textarea>
			</div>
			<div class="mui-input-row" style="height: 100px;">
				<label>备注</label>
				<textarea id="memo" rows="4"  ></textarea>
			</div>
		</form>
		
		<h5 id="num">变卖设备明细(0)</h5>
		
		<form class="mui-input-group">
				<div class="mui-input-row " style="height: 50px;">
					<button type="button"  id="import" class="mui-btn-primary mui-pull-right" style="margin-top:5px;margin-right:10px;width:30%;height:40px; font-size: 16px;">添加设备</button>
					<!--<button type="button" id="create_order" class="mui-btn-primary mui-pull-right" style="margin-top:5px ;margin-right:20px;width: 40%;height:40px;font-size: 16px;">生成领料出库单</button>-->
				</div>
			</form>
		
		<div class="listtip" style="clear:both">
			<p style="font-size: 16px;">点击添加设备按钮可添加设备明细</p>
		</div>
		<ul id="spare_list" class="mui-table-view mui-hidden">
		</ul>
		
	</div>	
	
	<script src="../../../mui/js/mui.min.js"></script>
	<script src="../../../jxm/js/jxm.js"></script>
	<script src="../../../jxm/js/jxm-util.js"></script>
	<script src="../../../jxm/js/combo-data.js"></script>
	<script type="text/javascript" charset="UTF-8">
	
      	var key_id = '';
      	var x;//保存删除前用到
      	var Params;//明细保存删除用
      	var target;
      	var total = 0;//用于删除
      	mui.init({  
		    beforeback: function() {  
			    //获得列表界面的webview  
			    var list = plus.webview.currentWebview().opener();  
			    //触发列表界面的自定义事件（refresh）,从而进行数据刷新  
			    mui.fire(list, 'reload');  
			    //返回true，继续页面关闭逻辑  
			    return true;  
	    	}
		});
  		
      	mui.plusReady(function(){
      		
      		//申请人默认当前用户
	      	var cur_user = localStorage.getItem('cur_user');
			var data = JSON.parse(cur_user);
			console.log('data:----'+JSON.stringify(data));
			document.getElementById('dept_name').value = data.dept_name;
//			document.getElementById('dept_code').value = data.dept_code;
			document.getElementById('dept_id').value = data.dept_id;
			document.getElementById('sec_dept').value = data.sec_dept;
			document.getElementById('sec_deptid').value = data.sec_deptid;
			document.getElementById('eidt_user').value = data.user_name;
			document.getElementById('eidt_userid').value = data.user_id;
			document.getElementById('apply_date').value = jxm.getToday();
			
			var self = plus.webview.currentWebview();
      		key_id = self.vary_id;
      		whereSql = self.whereSql;
//    		alert(orderid)
			if (key_id != undefined) {
				readData(key_id);
			}
	    });
      	
  		
  		//点击调入部门
  		var dept_name = 'select-dept_name';
		document.getElementById('dept_name').addEventListener('tap', function(){
			var href = "../../../app/util/select-dept.html";
//			var href = "../../app/util/test.html";
			var param = {callbackWinId:mui.currentWebview.id, callbackEvent:dept_name};
			jxm.open(href,{extras:{selectParams:param}});
		});
		window.addEventListener(dept_name, function(event){
			var obj = event.detail;
			document.getElementById('dept_name').value = obj.dataname;
			document.getElementById('dept_id').value = obj.dataid;
			document.getElementById('sec_dept').value = obj.dataext2;
			document.getElementById('sec_deptid').value = obj.dataext;
		});
  		
  		//点击导入按钮后选择设备
  		var selassetevent = 'select-asset';
  		document.getElementById('import').addEventListener('tap', function(){
			console.log("key_id:----"+key_id);
  			
			if (key_id == undefined) {
				mui.alert('请填写基础信息，保存后再添加设备！');
				return false;
			}
			var dept_id = document.getElementById('dept_id').value;
			var where_sql = "(device_id not in (select device_id from device_vary,device_vary_det where device_vary.vary_id=device_vary_det.vary_id and device_vary.auditing not in ('1','3') and device_vary.vary_type='allot') and status in ('6')) and (dept_id like ?||'%25')";
    			
			var href = "../../../app/util/select-device.html";
			var param = {callbackWinId:mui.currentWebview.id, callbackEvent:selassetevent, mutilsel:true,key_id:dept_id,where_sql:where_sql,fun_id:'sel_devicecard',type:'allot'};
			jxm.open(href,{extras:{selectParams:param}});
  		});
  		window.addEventListener(selassetevent, function(event){
			var objs = event.detail.selectdata;
		
  			//导入
			var params = "funid=sel_devicecard&destfunid=device_allot_det&pagetype=import&eventcode=import&parentId="+key_id;
			
			mui.each(objs, function(i, obj){
  				params += '&keyid='+obj.dataid;
  			});
  			//部门ID
  			mui.each(objs, function(i, obj){
  				params += '&device_vary_det.dept_id='+obj.datacode;
  			});
  			var e = encodeURIComponent;
  			//部门名称
  			mui.each(objs, function(i, obj){
  				params += '&device_vary_det.dept_name='+e(obj.dataname);
  			});
//			var data = '';
			jxm.post(params, function(data){
				
				console.log('导入：'+JSON.stringify(data));
				loadDet();
			});
			
			
		});
  		
  		var readData = function(key_id){
  			//基本信息发送请求
			var wheresql = 'device_vary.vary_id = ?';
			var params = "funid=queryevent&eventcode=query_data&query_funid=device_allot&query_type=0&has_page=1&limit=1"+
			"&where_sql="+wheresql+"&where_type=string&where_value="+key_id;
			
//			console.log('---'+params)
			jxm.post(params, function(data){
				console.log(JSON.stringify(data));
				data = data.root;
				data = data[0];
	    		
		    	document.getElementById('vary_code').value = data.device_vary__vary_code;
	  			document.getElementById('eidt_user').value = data.device_vary__eidt_user;
	  			document.getElementById('eidt_userid').value = data.device_vary__eidt_userid;
	  			document.getElementById('apply_date').value = data.device_vary__apply_date.substr(0,10);
	  			document.getElementById('vary_date').value = data.device_vary__vary_date;
	  			
	  			document.getElementById('sum_org_value').value = data.device_vary__sum_org_value;
	  			document.getElementById('dept_name').value = data.device_vary__dept_name;
	  			document.getElementById('dept_id').value = data.device_vary__dept_id;
	  			document.getElementById('sec_dept').value = data.device_vary__sec_dept;
	  			document.getElementById('sec_deptid').value = data.device_vary__sec_deptid;
	  			
	  			document.getElementById('reasons').value = data.device_vary__reasons;
	  			document.getElementById('tech_status').value = data.device_vary__tech_status;
	  			document.getElementById('memo').value = data.device_vary__memo;
  			
  				document.getElementById('receiving').value = data.device_vary__receiving;
	  			document.getElementById('sum_allot_money').value = data.device_vary__sum_allot_money;
	  			document.getElementById('sum_net_value').value = data.device_vary__sum_net_value;
	  			document.getElementById('sum_dep_value').value = data.device_vary__sum_dep_value;
	  			loadDet('det');
  			})
  		}
  		//加载人员明细
	   	var loadDet = function(type){
	   		
	   		document.getElementById('spare_list').innerHTML='';
	   		var wheresql = 'device_vary_det.vary_id = ?';
			var params = "funid=queryevent&eventcode=query_data&query_funid=device_allot_det&query_type=0&has_page=1&limit=100"+
			"&where_sql="+wheresql+"&where_type=string&where_value="+key_id;
			
			console.log('---'+params)
			jxm.post(params, function(data){
				console.log('------'+JSON.stringify(data));
				total = data.total;
				if (total == 0) {
					document.body.querySelector('.listtip').classList.remove('mui-hidden');
					return false;
				}
				document.getElementById('num').innerHTML = '变卖设备明细 ('+total+')';
				var sum_org_value = 0;
				var sum_net_value = 0;
				var sum_dep_value = 0;
				var sum_allot_money = 0;
				var org_value;
				var net_value;
				var dep_value;
				var allot_money;
				var li_html = document.getElementById('spare_list').innerHTML;
				
				data = data.root;
				
				mui.each(data, function(n, obj){
					org_value = obj.device_card__org_value;
					net_value = obj.device_card__net_value;
					dep_value = obj.device_card__dep_value;
					allot_money = obj.device_vary_det__allot_money;
					console.log('allot_money----'+allot_money);
					//统计设备总原值
					if (org_value.length != 0) {
						sum_org_value = parseFloat(sum_org_value)+parseFloat(org_value);
					}
					//统计设备总净值
					if (net_value.length != 0) {
						sum_net_value = parseFloat(sum_net_value)+parseFloat(net_value);
					}
					//统计总已提折旧
					if (dep_value.length != 0) {
						sum_dep_value = parseFloat(sum_dep_value)+parseFloat(dep_value);
					}
					//统计总变卖金额(元)
					if (allot_money != undefined) {
						sum_allot_money = parseFloat(sum_allot_money)+parseFloat(allot_money);
					}
					
					var has = false;
					if (!has) {
						li_html += '<li class="mui-table-view-cell" id="'+ obj.device_vary_det__vary_det_id;
						li_html +='" org_value="'+ org_value;
						li_html +='" net_value="'+ net_value;
						li_html +='" dep_value="'+ dep_value;
						li_html +='" allot_money="'+ allot_money+'">';
						
						li_html += ' <div class="mui-slider-right mui-disabled">';
						li_html += '	<a class="mui-btn mui-btn-grey">删除</a>';
						li_html += ' </div>';
						li_html += '<div class="mui-table mui-slider-handle">';
						li_html += '<div class="mui-table-cell mui-col-xs-10">';
				    	li_html += '<p class="p2">设备编号：'+ obj.device_card__device_code+ '</p>';
				    	li_html += '<p class="p2">设备名称：'+ obj.device_card__device_name+ '</p>';
				    	li_html += '<p class="p2">设备型号：'+ obj.device_card__device_type+ '</p>';
				    	li_html += '<p class="p2">设备规格：'+ obj.device_card__device_size+ '</p>';
//				    	li_html += '<p class="p2">设备原值(元)：'+ obj.device_card__org_value+ '</p>';
				    	
				    	
//				    	li_html += '<p class="p2">设备净值(元)：'+ obj.device_card__net_value+ '</p>';
//				    	li_html += '<p class="p2">设备折旧(元)：'+ obj.device_card__dep_value+ '</p>';
				    	li_html += '<p class="p2">变卖金额(元)：'+ obj.device_vary_det__allot_money+ '</p>';
				    	
						li_html += '</div>';
						li_html += '</div>';
						li_html += '</li>';
					}
					
				});
				document.getElementById('sum_org_value').value = sum_org_value;
				document.getElementById('sum_net_value').value = sum_net_value;
				document.getElementById('sum_dep_value').value = sum_dep_value;
				document.getElementById('sum_allot_money').value = sum_allot_money;
//				alert(sum_org_value);
				if (li_html.length > 0) {
					document.getElementById('spare_list').innerHTML = li_html;
					document.getElementById('spare_list').classList.remove('mui-hidden');
					document.body.querySelector('.listtip').classList.add('mui-hidden');
				} 
				if (type == undefined) {
					save('sub');
				}
				if (type == 'sub') {
					save('sub');
				}
				
			})
	   	}
	   	var btnArray = ['确认', '取消'];
		//向左拖拽后显示删除图标，释放后自动删除该条备件明细
		mui('#spare_list').on('slideleft', '.mui-table-view-cell', function(event) {
			var elem = this;
			var keyid = event.target.getAttribute('id');
			var org_value = event.target.getAttribute('org_value');
			var net_value = event.target.getAttribute('net_value');
			var dep_value = event.target.getAttribute('dep_value');
			var allot_money = event.target.getAttribute('allot_money');
			
			
			mui.confirm('确认删除该条明细？', '提示', btnArray, function(e) {
				if (e.index == 0) {
					
					var params = 'funid=device_seal_det&pagetype=editgrid&eventcode=delete_eg&keyid='+keyid;
					
					jxm.post(params, function(data){
		   				console.log(JSON.stringify(data));
		   				elem.parentNode.removeChild(elem);
		   				mui.toast('删除成功！');
		   				//删除后计算设备总原值与明细条数
						total = total-1;
						document.getElementById('num').innerHTML = '变卖设备明细 ('+total+')';
						if (org_value.length != 0) {
							var sum_org_value = 0;
							sum_org_value = document.getElementById('sum_org_value').value;
							sum_org_value = parseFloat(sum_org_value)-parseFloat(org_value);
							document.getElementById('sum_org_value').value = sum_org_value;
						}
						
						
						if (net_value.length != 0) {
							//删除成功后计算设备总净值
							var sum_net_value = 0;
							sum_net_value = document.getElementById('sum_net_value').value;
							sum_net_value = parseFloat(sum_net_value)-parseFloat(net_value);
							document.getElementById('sum_net_value').value = sum_net_value;
						}
						
						if (dep_value.length != 0 ) {
							//删除成功后计算总已提折旧
							var sum_dep_value = 0;
							sum_dep_value = document.getElementById('sum_dep_value').value;
							sum_dep_value = parseFloat(sum_dep_value)-parseFloat(dep_value);
							document.getElementById('sum_dep_value').value = sum_dep_value;
						}
						
						//删除成功后计算总变卖总金额
						if (allot_money.length != 0) {
//							var sum_allot_money = 0;
//							sum_allot_money = document.getElementById('sum_allot_money').value;
//							sum_allot_money = parseFloat(sum_allot_money)-parseFloat(allot_money);
//							document.getElementById('sum_allot_money').value = sum_allot_money;
							var sum_allot_money = 0;
							sum_allot_money = document.getElementById('sum_allot_money').value;
							sum_allot_money = parseFloat(sum_allot_money)-parseFloat(allot_money);
							document.getElementById('sum_allot_money').value = sum_allot_money;
						}
						
						setTimeout(function(){
//							save('sub');
							loadDet('sub');
						}, 500);
		   			})
				} else {
					setTimeout(function() {
						mui.swipeoutClose(elem);
					}, 0);
				}
			});
		});
		
		//设备明细列表添加单击事件
		mui("#spare_list").on('tap',".mui-table-view-cell",function(e){
			var item = this;
			var dataid = item.getAttribute("id");
//			alert(dataid)
			jxm.open('device-vary-det.html',{extras:{key_id:dataid,pfunid:'device_allot',funid:'device_allot_det',title:'变卖设备明细'}});
//			jxm.open('device-vary-det.html',{extras:{key_id:dataid,type:'edit'}});
	  		
		});
		
  		//保存基础信息
  		var save = function(type) {
  			
  			var vary_code = document.getElementById('vary_code').value;
  			var eidt_user = document.getElementById('eidt_user').value;
  			var eidt_userid = document.getElementById('eidt_userid').value;
  			var apply_date = document.getElementById('apply_date').value;
  			var dept_name = document.getElementById('dept_name').value;
  			var dept_id = document.getElementById('dept_id').value;
  			var sec_dept = document.getElementById('sec_dept').value;
  			var sec_deptid = document.getElementById('sec_deptid').value;
  			
  			
  			var vary_date = document.getElementById('vary_date').value;
  			var sum_net_value = document.getElementById('sum_net_value').value;
  			var sum_org_value = document.getElementById('sum_org_value').value;
  			var sum_dep_value = document.getElementById('sum_dep_value').value;
  			
  			var reasons = document.getElementById('reasons').value;
  			var tech_status = document.getElementById('tech_status').value;
  			var memo = document.getElementById('memo').value;
  			
  			var receiving = document.getElementById('receiving').value;
  			var sum_allot_money = document.getElementById('sum_allot_money').value;
  			
  			
			if ((!apply_date || apply_date.length == 0)) {
				mui.alert('请选择申请日期！');
				return false;
			}
			if ((!dept_name || dept_name.length == 0)) {
				mui.alert('请选择使用部门！');
				return false;
			}
			if (!reasons || reasons.length == 0) {
				mui.alert('请输入变卖原因！');
				return false;
			}
			if (!receiving || receiving.length == 0) {
				mui.alert('请输入接收单位！');
				return false;
			}
  			
  			
  			
  			var e = encodeURIComponent;
  			var params = 'funid=device_allot&pagetype=form';
  			
  			params += '&device_vary__vary_code='+ e(vary_code);
  			params += '&device_vary__eidt_user='+ e(eidt_user);
  			params += '&device_vary__eidt_userid='+ eidt_userid;
  			params += '&device_vary__apply_date='+ e(apply_date);
  			params += '&device_vary__vary_date='+e(vary_date);
  			params += '&device_vary__sum_org_value='+ sum_org_value;
  			
  			params += '&device_vary__dept_name='+ e(dept_name);
  			params += '&device_vary__dept_id='+ e(dept_id);
  			params += '&device_vary__sec_dept='+ e(sec_dept);
  			params += '&device_vary__sec_deptid='+ sec_deptid;
  			params += '&device_vary__reasons='+ e(reasons);
  			params += '&device_vary__tech_status='+ e(tech_status);
  			params += '&device_vary__memo='+ e(memo);
  			params += '&device_vary__sum_net_value='+ e(sum_net_value);
  			params += '&device_vary__sum_dep_value='+ e(sum_dep_value);
  			
  			params += '&device_vary__receiving='+ e(receiving);
  			
  			
  			params += '&device_vary__sum_allot_money='+ e(sum_allot_money);
  			
  			params += '&device_vary__vary_type=allot';
  			console.log(params);
  			
  			//有主键
			if (key_id != undefined) {
//				alert('save');
				params +='&eventcode=save&keyid='+key_id;
  				
				params += '&dirtyfields=device_vary.vary_code;device_vary.eidt_user;device_vary.eidt_userid;';
				params += 'device_vary.apply_date;device_vary.vary_date;device_vary.sum_org_value;device_vary.dept_name;';
				params += 'device_vary.dept_id;device_vary.sec_dept;device_vary.sec_deptid;';
				params += 'device_vary.reasons;device_vary.tech_status;device_vary.memo;';
	  			
	  			params += 'device_vary.sum_allot_money;device_vary.receiving;';
				params += 'device_vary.sum_net_value;device_vary.sum_dep_value';
//	  			params += '&dirtyfields=device_vary.memo;device_vary.vary_type';
	  				
			}
			//没有主键
			else{
//				alert('create');
				params +='&eventcode=create&device_vary__auditing=0';
				
			}
  			console.log(params);
  			
			jxm.post(params, function(data) {
				console.log('-保存--'+JSON.stringify(data));
				
				if (data.keyid) {
					key_id = data.keyid;
					//第一次保存后要重新加载页面
					readData(data.keyid);
				}
				//导入和删除后保存不提示
				if (type != 'sub') {
					mui.toast('保存成功！');
				}
			});
		};
  		//提交
  		var commit = function(){
  			var params = 'funid=device_allot&eventcode=audit&pagetype=form';
			params += '&auditvalue=1'+'&keyid='+key_id;

			//提交
			jxm.post(params, function(data){
				console.log(JSON.stringify(data))
				//获得列表界面的webview  
			    var list = plus.webview.currentWebview().opener();  
			    //触发列表界面的自定义事件（reload）,从而进行数据刷新  
			    mui.fire(list, 'refresh');
				
				mui.currentWebview.close('auto');
			})
  		};
  		
  		//点击基础信息保存按钮
		document.getElementById('save').addEventListener('tap', save);
		//点击提交按钮
		document.getElementById('btncommit').addEventListener('tap', commit);
		//自定义事件（refresh）,返回刷新数据  
  		window.addEventListener('loadDet', function(e) {  
            loadDet('sub');
//          save('sub');
        });
    </script>
</body>
</html>